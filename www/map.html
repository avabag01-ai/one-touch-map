<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <!-- PWA ì„¤ì • -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2196F3">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon-192.png">
    <title>ì›í„°ì¹˜ë§µ</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }


        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            overflow: hidden;
        }

        /* ë’¤ë¡œê°€ê¸° ë²„íŠ¼ (ë™ê·¸ë¼ë¯¸) */
        .back-btn {
            position: fixed;
            top: 12px;
            left: 12px;
            z-index: 1000;
            background: white;
            border: 2px solid #CCC;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            color: #333;
        }

        .back-btn:active {
            background: #F0F0F0;
        }

        /* ë ˆì´ì–´ í† ê¸€ ë²„íŠ¼ */
        .layer-toggle-btn {
            position: fixed;
            top: 12px;
            left: 64px;
            z-index: 1000;
            background: white;
            border: 2px solid #CCC;
            border-radius: 22px;
            height: 44px;
            padding: 0 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            color: #333;
        }

        .layer-toggle-btn:active {
            background: #F0F0F0;
        }

        /* ë ˆì´ì–´ í•„í„° (ì ‘ì´ì‹) */
        .layer-filter {
            position: fixed;
            top: 64px;
            left: 12px;
            background: white;
            border-radius: 12px;
            display: none;
            gap: 4px;
            padding: 8px;
            z-index: 999;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            flex-wrap: wrap;
            width: 220px;
        }

        .layer-filter.open {
            display: flex;
        }

        .filter-btn {
            flex: 1;
            min-width: 40px;
            background: #F5F5F5;
            border: 2px solid #CCC;
            border-radius: 6px;
            padding: 8px 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: #666;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
        }

        .filter-btn:active {
            transform: scale(0.95);
        }

        /* ì§€ë„ - ì „ì²´í™”ë©´ */
        #map {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1;
        }

        /* VWorld íƒ€ì¼ - ë°°ê²½ ì•½ê°„ ì–´ë‘¡ê²Œ í•´ì„œ ê¸€ì ê°€ì‹œì„± UP */
        .leaflet-tile {
            filter: brightness(0.95) contrast(1.15);
        }

        /* WMS ê±´ë¬¼ë²ˆí˜¸ ë ˆì´ì–´ í™•ëŒ€ */
        .leaflet-tile-pane .leaflet-layer:last-child .leaflet-tile {
            transform: scale(1.15);
            transform-origin: center;
        }

        /* ì»¤ìŠ¤í…€ ë§ˆì»¤ - ë°˜íˆ¬ëª…, ì‘ì€ í¬ê¸°, ê°€ë³€ ë„ˆë¹„ */
        .custom-marker {
            background: rgba(128, 128, 128, 0.7); /* ê¸°ë³¸: íšŒìƒ‰ (ë¯¸ì§€ì •) - ë°˜íˆ¬ëª… */
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.9);
            border-radius: 3px;
            min-width: 24px;
            max-width: 60px;
            height: 20px;
            padding: 2px 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
            letter-spacing: -0.5px;
            text-shadow: 0.5px 0.5px 1px rgba(0, 0, 0, 0.7);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ê¸´ê¸‰ ë§ˆì»¤ëŠ” ìµœìš°ì„  */
        .custom-marker.urgent {
            background: rgba(244, 67, 54, 0.8) !important;
            border-color: rgba(255, 255, 255, 1) !important;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }

        /* ë ˆì´ì–´ë³„ ìƒ‰ìƒ - ì§€ê¸ˆê°ˆê³³ë§Œ ì„ ëª…í•˜ê²Œ */
        .custom-marker.layer-1 {
            background: rgba(33, 150, 243, 0.9); /* ì§€ê¸ˆê°ˆê³³: íŒŒë‘ - ì„ ëª… */
        }

        .custom-marker.layer-2 {
            background: rgba(255, 152, 0, 0.4); /* ë‚˜ì¤‘ì—ê°ˆê³³: ì£¼í™© - íˆ¬ëª… */
        }

        .custom-marker.layer-3 {
            background: rgba(144, 238, 144, 0.4); /* ì „ì²´: ì—°ë‘ - íˆ¬ëª… */
        }

        .custom-marker.layer-0 {
            background: rgba(128, 128, 128, 0.4); /* ë¯¸ì§€ì •: íšŒìƒ‰ - íˆ¬ëª… */
        }

        /* í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼ */
        .location-btn {
            position: fixed;
            bottom: 80px;
            right: 16px;
            z-index: 500;
            background: white;
            border: 2px solid #CCC;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .location-btn:active {
            background: #F0F0F0;
        }

        /* ì¤‘ì•™ ê³ ì • GPS ë§ˆì»¤ (ì§€ë„ê°€ ì›€ì§ì´ëŠ” ë°©ì‹) */
        .center-marker {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #FF0000;
            border: 3px solid #FFFFFF;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            pointer-events: none;
        }
    </style>
</head>

<body>
    <!-- ë’¤ë¡œê°€ê¸° ë²„íŠ¼ -->
    <button class="back-btn" onclick="location.href='list.html'">â†</button>
    <span id="headerTitle" style="display:none;"></span>

    <!-- ë ˆì´ì–´ í† ê¸€ ë²„íŠ¼ -->
    <button class="layer-toggle-btn" id="layerToggleBtn">L í•„í„°</button>

    <!-- ë ˆì´ì–´ í•„í„° (ì ‘ì´ì‹) -->
    <div class="layer-filter" id="layerFilter">
        <button class="filter-btn active" data-layer="all">ì „ì²´</button>
        <button class="filter-btn" data-layer="1" style="background: #2196F3; color: white;">ì§€ê¸ˆê°ˆê³³</button>
        <button class="filter-btn" data-layer="2" style="background: #FF9800; color: white;">ë‚˜ì¤‘ì—ê°ˆê³³</button>
        <button class="filter-btn" data-layer="3" style="background: #90EE90; color: white;">ì „ì²´í‘œì‹œ</button>
        <button class="filter-btn" data-layer="0">ë¯¸ì§€ì •</button>
    </div>

    <!-- ì§€ë„ - ì „ì²´í™”ë©´ -->
    <div id="map" style="position: absolute; top: 0; bottom: 0; width: 100%; height: 100vh;"></div>

    <!-- ì¤‘ì•™ ê³ ì • GPS ë§ˆì»¤ -->
    <div class="center-marker" id="centerMarker" style="display: none;"></div>

    <!-- í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼ -->
    <button class="location-btn" id="locationBtn">ğŸ“</button>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Rotate -->
    <script src="https://unpkg.com/leaflet-rotate@0.2.8/dist/leaflet-rotate-src.js"></script>

    <script src="android-back.js"></script>
    <script src="route-optimizer.js"></script>
    <script>
        // Desktop User-Agent Spoofing
        if (navigator.userAgentData) {
            // High-level API for modern browsers
            console.log("Spoofing User-Agent hints...");
        }

        // ë¸Œë¼ìš°ì € ë Œë”ë§ ìµœì í™” ë° ì „ì²´í™”ë©´ ìœ ë„
        window.addEventListener('load', () => {
            window.scrollTo(0, 1);
            document.documentElement.style.height = '100vh';
            document.body.style.height = '100vh';
        });

        let map;
        let markers = [];
        let deliveries = [];
        let currentLayer = 'all';
        let selectedDate = new Date().toISOString().split('T')[0];

        // ì§€ë„ ì´ˆê¸°í™”
        function initMap() {
            const center = [37.6063, 127.0925]; // ì¤‘ë‘êµ¬ ì¤‘ì‹¬

            // ì§€ë„ íšŒì „ ê¸°ëŠ¥ í™œì„±í™” (rotate: true)
            map = L.map('map', {
                center: center,
                zoom: 18,
                zoomControl: false,
                rotate: true,     // íšŒì „ í™œì„±í™”
                touchRotate: true // í„°ì¹˜ íšŒì „ í™œì„±í™”
            });

            L.control.zoom({ position: 'bottomright' }).addTo(map);

            // ì¤Œ ë³€ê²½ ì´ë²¤íŠ¸: ë§ˆì»¤ ë¼ë²¨ ì—…ë°ì´íŠ¸
            map.on('zoomend', () => {
                const currentZoom = map.getZoom();
                map.eachLayer(layer => {
                    if (layer instanceof L.Marker && layer._customData) {
                        const { buildingNo, seqNo } = layer._customData;
                        const newLabel = currentZoom >= 16 ? (buildingNo || seqNo) : seqNo;
                        const markerElement = layer.getElement();
                        if (markerElement) {
                            const span = markerElement.querySelector('span');
                            if (span) span.textContent = newLabel;
                        }
                    }
                });
            });

            loadDeliveries();
            setupLayerFilter();
            setInitialMapLayer();
            setupMapClickAddress();
        }

        function setInitialMapLayer() {
            // 1. ë°°ê²½ì§€ë„ (Base)
            if (vworldBaseLayer) map.removeLayer(vworldBaseLayer);

            vworldBaseLayer = L.tileLayer('https://api.vworld.kr/req/wmts/1.0.0/' + VWORLD_KEY + '/Base/{z}/{y}/{x}.png', {
                attribution: 'Â© VWorld',
                maxZoom: 19,
                tileSize: 256
            }).addTo(map);

            // 2. ë„ë¡œëª…ì£¼ì†Œ ê±´ë¬¼ ë ˆì´ì–´ (lt_c_spbd) - ê±´ë¬¼ ìœ„ ë²ˆí˜¸ë§Œ í‘œì‹œ (íˆ¬ëª… ë°°ê²½)
            if (addressLayer) map.removeLayer(addressLayer);

            addressLayer = L.tileLayer.wms('https://api.vworld.kr/req/wms', {
                layers: 'lt_c_spbd',
                styles: 'lt_c_spbd',
                format: 'image/png',
                transparent: true,
                version: '1.3.0',
                key: VWORLD_KEY,
                domain: 'localhost',
                minZoom: 14,
                maxZoom: 19,
                zIndex: 200
            }).addTo(map);
        }

        function setupLayerFilter() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentLayer = btn.dataset.layer;
                    displayMarkers();
                });
            });
        }

        function loadDeliveries() {
            const saved = localStorage.getItem('deliveries');
            if (saved) {
                deliveries = JSON.parse(saved);
                displayMarkers();
            }
        }

        // ë§ˆì»¤ í‘œì‹œ (ì§€ë²ˆ ì›ë¦¬ + ê²¹ì¹¨ í¼ì¹˜ê¸°)
        async function displayMarkers() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            // 1. ë‚ ì§œ ê²°ì • (ë¦¬ìŠ¤íŠ¸ì—ì„œ ë„˜ì–´ì˜¨ íŠ¹ì • ì•„ì´ë””ê°€ ìˆë‹¤ë©´ í•´ë‹¹ ë‚ ì§œ ìš°ì„ )
            const targetId = localStorage.getItem('selectedDeliveryId');
            if (targetId) {
                const target = deliveries.find(d => String(d.id) === String(targetId));
                if (target && target.createdAt) {
                    selectedDate = target.createdAt;
                }
            }

            // 2. í•„í„°ë§ (ë ˆì´ì–´ë§Œ - ë‚ ì§œ í•„í„° ì œê±°)
            let filtered = [...deliveries];

            console.log('ì „ì²´ ë°°ì†¡ì§€:', deliveries.length);
            console.log('í˜„ì¬ ë ˆì´ì–´:', currentLayer);

            // "all"ì´ë©´ ëª¨ë“  ë§ˆì»¤ í‘œì‹œ (ë ˆì´ì–´ë³„ ìƒ‰ìƒ ìœ ì§€)
            // íŠ¹ì • ë ˆì´ì–´ ë²ˆí˜¸ë©´ í•´ë‹¹ ë ˆì´ì–´ë§Œ í•„í„°ë§
            if (currentLayer !== 'all') {
                const layerNum = parseInt(currentLayer);
                console.log('ë ˆì´ì–´ ë²ˆí˜¸:', layerNum);
                const beforeFilter = filtered.length;
                filtered = filtered.filter(d => {
                    const hasLayer = (d.layer || 0) === layerNum;
                    console.log(`ë°°ì†¡ì§€ ${d.id} (${d.addressBefore}): layer=${d.layer}, í•„ìš”=${layerNum}, ì¼ì¹˜=${hasLayer}`);
                    return hasLayer;
                });
                console.log('ë ˆì´ì–´ í•„í„° ì „:', beforeFilter, 'ë ˆì´ì–´ í•„í„° í›„:', filtered.length);
            } else {
                console.log('ì „ì²´ ëª¨ë“œ: ëª¨ë“  ë§ˆì»¤ í‘œì‹œ (ë ˆì´ì–´ë³„ ìƒ‰ìƒ ì ìš©)');
            }

            let needSave = false;
            const posTracker = {};

            for (let i = 0; i < filtered.length; i++) {
                const delivery = filtered[i];
                const originalIndex = deliveries.indexOf(delivery);

                // ì§€ë²ˆ ì›ë¦¬ë¡œ ì¢Œí‘œ ì°¾ê¸°
                if (!delivery.lat || !delivery.lng) {
                    const coords = await geocodeAddressVWorld(delivery.fullAddress);
                    if (coords) {
                        delivery.lat = coords.lat;
                        delivery.lng = coords.lng;
                        needSave = true;
                    }
                    await new Promise(r => setTimeout(r, 150));
                }

                let lat = delivery.lat;
                let lng = delivery.lng;

                if (lat && lng) {
                    // ë°ì´í„° ì •ì œ: ì´ë¯¸ ìˆëŠ” ë„ë¡œëª…ì£¼ì†Œê°€ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´(ë¡œ/ê¸¸ ì—†ìŒ) ì‚­ì œí•˜ì—¬ ì¬ì¡°íšŒ ìœ ë„
                    if (delivery.roadAddress && !/[ë¡œê¸¸]/.test(delivery.roadAddress)) {
                        delivery.roadAddress = null;
                        needSave = true;
                    }

                    // ìˆ˜ë™ ì…ë ¥ëœ addressAfterê°€ ìˆìœ¼ë©´ ë„ë¡œëª…ì£¼ì†Œë¡œ ì‚¬ìš©
                    if (!delivery.roadAddress && delivery.addressAfter && /[ë¡œê¸¸]/.test(delivery.addressAfter)) {
                        delivery.roadAddress = delivery.addressAfter;
                        needSave = true;
                    }

                    // ì‹ ì£¼ì†Œ(ë„ë¡œëª…) ì—†ìœ¼ë©´ ì¡°íšŒ (ì¢Œí‘œê°€ ìˆì„ ë•Œë§Œ)
                    if (!delivery.roadAddress) {
                        const roadAddr = await getRoadAddressFromCoords(lat, lng);
                        if (roadAddr) {
                            delivery.roadAddress = roadAddr;
                            needSave = true;
                            await new Promise(r => setTimeout(r, 50)); // API ë¶€í•˜ ë°©ì§€
                        }
                    }

                    const posKey = `${lat.toFixed(6)},${lng.toFixed(6)}`;
                    if (posTracker[posKey]) {
                        const count = posTracker[posKey];
                        const angle = (count * 137.5) * (Math.PI / 180);
                        const radius = 0.00006 * Math.sqrt(count);
                        lat += Math.cos(angle) * radius;
                        lng += Math.sin(angle) * radius;
                        posTracker[posKey]++;
                    } else {
                        posTracker[posKey] = 1;
                    }

                    const markerDiv = document.createElement('div');
                    // ë ˆì´ì–´ í´ë˜ìŠ¤ (undefinedë‚˜ nullì´ë©´ layer-0ìœ¼ë¡œ ì²˜ë¦¬)
                    const layerValue = delivery.layer !== undefined && delivery.layer !== null ? delivery.layer : 0;
                    const layerClass = `layer-${layerValue}`;
                    const urgentClass = delivery.priority === 'urgent' ? 'urgent' : '';
                    markerDiv.className = `custom-marker ${urgentClass} ${layerClass}`;
                    console.log(`ë§ˆì»¤ ìƒì„±: ID=${delivery.id}, layer=${delivery.layer}, className="${markerDiv.className}"`);

                    // ì‹ ì£¼ì†Œ ê±´ë¬¼ ë²ˆí˜¸ ì¶”ì¶œ (roadAddress ìš°ì„ , ì—†ìœ¼ë©´ addressBefore/addressAfter)
                    let buildingNo = "";
                    // roadAddress(ë„ë¡œëª…ì£¼ì†Œ)ë¥¼ ìµœìš°ì„ ìœ¼ë¡œ ì‚¬ìš©
                    const addrSrc = delivery.roadAddress || delivery.addressAfter || delivery.addressBefore || '';
                    if (addrSrc) {
                        // ëª¨ë“  [ë¡œê¸¸] ë’¤ ìˆ«ìë¥¼ ì°¾ê³  ë§ˆì§€ë§‰ ê²ƒ ì‚¬ìš©
                        const matches = [...addrSrc.matchAll(/[ë¡œê¸¸]\s*(\d+(?:-\d+)?)/g)];
                        if (matches.length > 0) buildingNo = matches[matches.length - 1][1];
                    }

                    // ìˆœë²ˆ
                    const seqNo = originalIndex + 1;

                    // ì¤Œ ë ˆë²¨ì— ë”°ë¼ í‘œì‹œ ë‚´ìš© ê²°ì •: 16 ì´ìƒì´ë©´ ê±´ë¬¼ë²ˆí˜¸, ë¯¸ë§Œì´ë©´ ìˆœë²ˆ
                    const currentZoom = map.getZoom();
                    const initialLabel = currentZoom >= 16 ? (buildingNo || seqNo) : seqNo;

                    markerDiv.innerHTML = `<span>${initialLabel}</span>`;
                    markerDiv.dataset.buildingNo = buildingNo;
                    markerDiv.dataset.seqNo = seqNo;

                    const icon = L.divIcon({
                        html: markerDiv.outerHTML,
                        className: '',
                        iconSize: null,
                        iconAnchor: [12, 10]
                    });

                    const marker = L.marker([lat, lng], { icon: icon }).addTo(map);

                    // ì¤Œ ë³€ê²½ ì‹œ ë§ˆì»¤ ë¼ë²¨ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ ì €ì¥
                    marker._customData = {
                        buildingNo: buildingNo,
                        seqNo: seqNo
                    };

                    const popupContent = document.createElement('div');
                    const roadAddr = delivery.roadAddress || delivery.addressAfter || '';

                    // OCR ì •ë³´ê°€ ìˆìœ¼ë©´ í•œ ë²ˆì— í‘œì‹œ
                    const hasInfo = delivery.phone || delivery.tonnage || delivery.memo;
                    const infoSection = hasInfo
                        ? `<div style="background:#E3F2FD; padding:8px; border-radius:6px; margin-bottom:10px; border-left:3px solid #2196F3;">
                            ${delivery.phone ? `<div style="margin-bottom:4px;"><a href="tel:${delivery.phone}" style="color:#1976D2; text-decoration:none; font-size:13px; font-weight:bold;">ğŸ“ ${delivery.phone}</a></div>` : ''}
                            ${delivery.tonnage ? `<div style="margin-bottom:4px;"><span style="background:#FF7043; color:white; padding:2px 6px; border-radius:4px; font-size:11px; font-weight:bold;">${delivery.tonnage}í†¤</span></div>` : ''}
                            ${delivery.memo ? `<div style="margin-top:6px; padding-top:6px; border-top:1px solid #BBDEFB;"><div style="font-size:11px; color:#1976D2; font-weight:bold; margin-bottom:2px;">ğŸ“ ë©”ëª¨</div><div style="font-size:13px; color:#333;">${delivery.memo}</div></div>` : ''}
                           </div>`
                        : '';

                    popupContent.innerHTML = `
                        ${infoSection}
                        <div style="margin-bottom:8px;">
                            ${roadAddr ? `<b style="color:#1976D2; font-size:14px;">ğŸ“ ${roadAddr}</b><br>` : ''}
                            <span style="color:#666; font-size:12px;">${delivery.addressBefore || ''}</span>
                        </div>
                        <button onclick="deleteDelivery(${delivery.id})" style="background:#F44336; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; width:100%;">ì‚­ì œ</button>
                    `;
                    marker.bindPopup(popupContent);
                    markers.push(marker);

                    // íŠ¹ì • ì•„ì´ë””ê°€ ì„ íƒë˜ì–´ ë„˜ì–´ì˜¨ ê²½ìš° í•´ë‹¹ ë§ˆì»¤ ê°•ì¡° ë° ì´ë™
                    if (targetId && String(delivery.id) === String(targetId)) {
                        map.setView([lat, lng], 19);
                        marker.openPopup();
                        localStorage.removeItem('selectedDeliveryId'); // í•œ ë²ˆë§Œ ìˆ˜í–‰
                    }
                }
            }

            if (needSave) localStorage.setItem('deliveries', JSON.stringify(deliveries));

            if (markers.length > 0 && !targetId) {
                const group = L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.3), { maxZoom: 18 });
            } else if (markers.length === 0) {
                map.setView([37.6063, 127.0925], 16);
            }

            const totalCount = deliveries.length;
            const filteredCount = filtered.length;
            document.getElementById('headerTitle').textContent = `ì›í„°ì¹˜ ì§€ë„ (${filteredCount}/${totalCount})`;
        }

        // ì§€ë²ˆ ìš°ì„  ì£¼ì†Œ ë³€í™˜ (ì›ë³¸ ì£¼ì†Œ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
        async function geocodeAddressVWorld(address) {
            if (typeof RouteOptimizer === "undefined") return null;
            return await RouteOptimizer.fetchVWorldCoord(address);
        }

        // ë°°ì†¡ì§€ ì‚­ì œ í•¨ìˆ˜
        function deleteDelivery(id) {
            const index = deliveries.findIndex(d => d.id === id);
            if (index !== -1) {
                deliveries.splice(index, 1);
                localStorage.setItem('deliveries', JSON.stringify(deliveries));
                displayMarkers();
            }
        }

        // [í•µì‹¬] ëª¨ë“  ì£¼ì†Œë¥¼ ì§€ë²ˆ ì›ë¦¬ë¡œ ê°•ì œ ì¬ì •ë ¬
        async function relocateAllMarkers() {
            deliveries.forEach(d => {
                d.lat = null;
                d.lng = null;
                d.roadAddress = null; // ë„ë¡œëª…ì£¼ì†Œë„ ì´ˆê¸°í™”í•˜ì—¬ ì¬ì¡°íšŒ ìœ ë„
            });

            const btn = document.getElementById('relocateBtn');
            btn.textContent = 'ì •ë ¬ì¤‘...';
            btn.disabled = true;

            await displayMarkers();

            btn.textContent = 'ì§€ë²ˆì •ë ¬';
            btn.disabled = false;
        }

        // VWorld ì„¤ì •
        let vworldBaseLayer;
        let addressLayer; // ë„ë¡œëª…ì£¼ì†Œ ë ˆì´ì–´
        const VWORLD_KEY = 'EEB68327-5D04-3BE3-9072-D3ECFCCC26A2';

        // ì¢Œí‘œë¡œ ë„ë¡œëª…ì£¼ì†Œ ì¡°íšŒ (VWorld API)
        async function getRoadAddressFromCoords(lat, lng) {
            try {
                const url = `https://api.vworld.kr/req/address?service=address&request=getAddress&version=2.0&crs=epsg:4326&point=${lng},${lat}&format=json&type=ROAD&key=${VWORLD_KEY}`;
                const res = await fetch(url);
                const data = await res.json();
                if (data.response && data.response.status === 'OK' && data.response.result) {
                    const text = data.response.result[0].text;
                    // ê°•ì œ ê²€ì¦: 'ë¡œ'ë‚˜ 'ê¸¸'ì´ ì—†ìœ¼ë©´ ë„ë¡œëª…ì£¼ì†Œê°€ ì•„ë‹˜ (ì§€ë²ˆì¼ ìˆ˜ ìˆìŒ) -> ë¬´ì‹œ
                    if (/[ë¡œê¸¸]/.test(text)) {
                        return text;
                    }
                }
            } catch (e) {
                console.error("Road address fetch failed", e);
            }
            return null;
        }

        // ì§€ë„ í´ë¦­ ì‹œ ì£¼ì†Œ ì¡°íšŒ ê¸°ëŠ¥ ì œê±° (ë¶ˆí•„ìš”)
        function setupMapClickAddress() {
            // ê¸°ëŠ¥ ë¹„í™œì„±í™”
        }

        let watchId = null;
        let isTrackingEnabled = false;

        // ìë™ ìœ„ì¹˜ ì¶”ì  ì‹œì‘ (ì§€ë„ ì¤‘ì‹¬ ê³ ì • ë°©ì‹)
        function startLocationTracking() {
            if (!navigator.geolocation) {
                alert('ì´ ê¸°ê¸°ëŠ” GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }

            isTrackingEnabled = true;
            document.getElementById('centerMarker').style.display = 'block';
            document.getElementById('locationBtn').style.background = '#4CAF50'; // ì¶”ì  ì¤‘ í‘œì‹œ

            watchId = navigator.geolocation.watchPosition(
                (pos) => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;

                    // ì§€ë„ ì¤‘ì‹¬ì„ í˜„ì¬ ìœ„ì¹˜ë¡œ ì¦‰ì‹œ ì´ë™ (ë§ˆì»¤ëŠ” í™”ë©´ ì¤‘ì•™ ê³ ì •)
                    if (isTrackingEnabled) {
                        map.setView([lat, lng], map.getZoom(), { animate: false });
                    }

                    console.log('í˜„ì¬ ìœ„ì¹˜ ì—…ë°ì´íŠ¸:', lat, lng);
                },
                (error) => {
                    console.error('ìœ„ì¹˜ ì¶”ì  ì˜¤ë¥˜:', error);
                    // ì²« ì˜¤ë¥˜ë§Œ ì•Œë¦¼ (ë°˜ë³µ ì•Œë¦¼ ë°©ì§€)
                    if (!window.gpsErrorShown) {
                        window.gpsErrorShown = true;
                        let errorMsg = 'ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMsg += 'GPS ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.\nì„¤ì •ì—ì„œ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMsg += 'ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nGPSë¥¼ ì¼œì£¼ì„¸ìš”.';
                                break;
                            case error.TIMEOUT:
                                errorMsg += 'ìœ„ì¹˜ ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.';
                                break;
                            default:
                                errorMsg += 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                        }
                        alert(errorMsg);
                    }
                },
                {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                }
            );
        }

        // ìœ„ì¹˜ ì¶”ì  ì¤‘ì§€
        function stopLocationTracking() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            isTrackingEnabled = false;
            document.getElementById('centerMarker').style.display = 'none';
            document.getElementById('locationBtn').style.background = 'white';
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ìœ„ì¹˜ ì¶”ì  ì‹œì‘
        startLocationTracking();

        document.getElementById('locationBtn').addEventListener('click', () => {
            if (navigator.geolocation) {
                // ìœ„ì¹˜ ìš”ì²­ ì¤‘ í‘œì‹œ
                const btn = document.getElementById('locationBtn');
                btn.textContent = 'â³';

                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        const lat = pos.coords.latitude;
                        const lng = pos.coords.longitude;
                        map.setView([lat, lng], 18);

                        // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
                        if (userLocationMarker) {
                            map.removeLayer(userLocationMarker);
                        }

                        // ë¹¨ê°„ ì ìœ¼ë¡œ í˜„ì¬ ìœ„ì¹˜ í‘œì‹œ
                        userLocationMarker = L.circleMarker([lat, lng], {
                            radius: 8,
                            fillColor: '#FF0000',
                            color: '#FFFFFF',
                            weight: 3,
                            opacity: 1,
                            fillOpacity: 1
                        }).addTo(map);

                        btn.textContent = 'ğŸ“';
                        console.log('í˜„ì¬ ìœ„ì¹˜:', lat, lng);
                    },
                    (error) => {
                        btn.textContent = 'ğŸ“';
                        console.error('ìœ„ì¹˜ ì˜¤ë¥˜:', error);
                        alert('ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nGPSë¥¼ ì¼œì£¼ì„¸ìš”.\n\nì˜¤ë¥˜: ' + error.message);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                alert('ì´ ê¸°ê¸°ëŠ” ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            initMap(); // ì´ˆê¸°í™”í•˜ë©´ì„œ layerë„ ì„¤ì •ë¨

            // ë ˆì´ì–´ í•„í„° í† ê¸€
            document.getElementById('layerToggleBtn').addEventListener('click', () => {
                document.getElementById('layerFilter').classList.toggle('open');
            });
            // ì§€ë„ í´ë¦­ ì‹œ í•„í„° ë‹«ê¸°
            map.on('click', () => {
                document.getElementById('layerFilter').classList.remove('open');
            });

            // ì§€ë²ˆ ì¬ì •ë ¬ ë²„íŠ¼
            const relBtn = document.createElement('button');
            relBtn.id = 'relocateBtn';
            relBtn.className = 'location-btn';
            relBtn.style.bottom = '140px';
            relBtn.style.fontSize = '12px';
            relBtn.style.fontWeight = 'bold';
            relBtn.style.background = '#FF5252';
            relBtn.style.color = 'white';
            relBtn.textContent = 'ì§€ë²ˆì •ë ¬';
            relBtn.onclick = relocateAllMarkers;
            document.body.appendChild(relBtn);

            // ë‚ ì§œ ë³€ê²½ ê¸°ëŠ¥ ì œê±°ë¨ (í—¤ë” ì—†ìŒ)
        });
    </script>
</body>

</html>