<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <!-- PWA ì„¤ì • -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2196F3">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon-192.png">
    <title>ì›í„°ì¹˜ë§µ</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }


        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            overflow: hidden;
        }

        /* ë’¤ë¡œê°€ê¸° ë²„íŠ¼ (ë™ê·¸ë¼ë¯¸) */
        .back-btn {
            position: fixed;
            top: 12px;
            left: 12px;
            z-index: 1000;
            background: white;
            border: 2px solid #CCC;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            color: #333;
        }

        .back-btn:active {
            background: #F0F0F0;
        }

        /* ë ˆì´ì–´ í† ê¸€ ë²„íŠ¼ */
        .layer-toggle-btn {
            position: fixed;
            top: 12px;
            left: 64px;
            z-index: 1000;
            background: white;
            border: 2px solid #CCC;
            border-radius: 22px;
            height: 44px;
            padding: 0 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            color: #333;
        }

        .layer-toggle-btn:active {
            background: #F0F0F0;
        }

        /* ë ˆì´ì–´ í•„í„° (ì ‘ì´ì‹) */
        .layer-filter {
            position: fixed;
            top: 64px;
            left: 12px;
            background: white;
            border-radius: 12px;
            display: none;
            gap: 4px;
            padding: 8px;
            z-index: 999;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            flex-wrap: wrap;
            width: 220px;
        }

        .layer-filter.open {
            display: flex;
        }

        .filter-btn {
            flex: 1;
            min-width: 40px;
            background: #F5F5F5;
            border: 2px solid #CCC;
            border-radius: 6px;
            padding: 8px 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: #666;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
        }

        .filter-btn:active {
            transform: scale(0.95);
        }

        /* ì§€ë„ - ì „ì²´í™”ë©´ */
        #map {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1;
        }

        /* VWorld íƒ€ì¼ - ë°°ê²½ ì•½ê°„ ì–´ë‘¡ê²Œ í•´ì„œ ê¸€ì ê°€ì‹œì„± UP */
        .leaflet-tile {
            filter: brightness(0.95) contrast(1.15);
        }

        /* WMS ê±´ë¬¼ë²ˆí˜¸ ë ˆì´ì–´ í™•ëŒ€ */
        .leaflet-tile-pane .leaflet-layer:last-child .leaflet-tile {
            transform: scale(1.4);
            transform-origin: center;
        }

        /* ì»¤ìŠ¤í…€ ë§ˆì»¤ - ì‚¬ê°í˜•, ì™¸ê³½ì„  ì—†ìŒ */
        .custom-marker {
            background: rgba(33, 150, 243, 0.9);
            color: white;
            border: none;
            border-radius: 3px;
            min-width: 24px;
            height: 20px;
            padding: 0 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 500;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            letter-spacing: 0.5px;
        }

        .custom-marker.urgent {
            background: #F44336;
        }

        /* í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼ */
        .location-btn {
            position: fixed;
            bottom: 80px;
            right: 16px;
            z-index: 500;
            background: white;
            border: 2px solid #CCC;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .location-btn:active {
            background: #F0F0F0;
        }

        /* GPS íŒŒë€ ì  + Pulse */
        .gps-pulse-icon {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gps-dot {
            width: 14px;
            height: 14px;
            background-color: #2196F3;
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }

        .gps-pulse {
            position: absolute;
            width: 40px;
            height: 40px;
            background-color: rgba(33, 150, 243, 0.4);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
            z-index: 1;
        }

        @keyframes pulse {
            0% {
                transform: scale(0.5);
                opacity: 0.8;
            }

            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        /* í™œì„±í™”ëœ ë²„íŠ¼ */
        .location-btn.active {
            background-color: #2196F3;
            color: white;
            border-color: #2196F3;
        }
    </style>
</head>

<body>
    <!-- ë’¤ë¡œê°€ê¸° ë²„íŠ¼ -->
    <button class="back-btn" onclick="location.href='index.html'">â†</button>
    <span id="headerTitle" style="display:none;"></span>

    <!-- ìƒë‹¨ ë ˆë²¨ í•„í„° ì œê±°ë¨ (ìš”ì²­ì— ë”°ë¼ ì‚­ì œ) -->

    <!-- ë ˆì´ì–´ í† ê¸€ ë²„íŠ¼ (ì „ì²´ / ì§€ê¸ˆê°ˆê³³ í† ê¸€) -->
    <button class="layer-toggle-btn" id="layerToggleBtn" style="left:64px; font-size:11px;">ì „ì²´ë³´ê¸°</button>

    <!-- ì§€ë„ - ì „ì²´í™”ë©´ -->
    <div id="map" style="position: absolute; top: 0; bottom: 0; width: 100%; height: 100vh;"></div>

    <!-- í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼ -->
    <button class="location-btn" id="locationBtn">ğŸ“</button>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Rotate -->
    <script src="https://unpkg.com/leaflet-rotate@0.2.8/dist/leaflet-rotate-src.js"></script>
    <!-- Leaflet GoogleMutant í”ŒëŸ¬ê·¸ì¸ -->
    <script src="https://unpkg.com/leaflet.gridlayer.googlemutant@latest/dist/Leaflet.GoogleMutant.js"></script>

    <script src="android-back.js"></script>
    <script src="route-optimizer.js"></script>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let map;
        let deliveries = [];
        let markers = [];
        let currentLayer = 'all';
        let googleLayer = null;
        let currentBaseMap = 'vworld'; // 'vworld' or 'google'

        // ì§€ë„ ì´ˆê¸°í™”
        function initMap() {
            // [ì¤‘ìš”] touchRotate: true ì¶”ê°€í•˜ì—¬ ëª¨ë°”ì¼ íšŒì „ í™œì„±í™”
            map = L.map('map', {
                rotate: true,
                touchRotate: true,
                attributionControl: false,
                rotateControl: {
                    closeOnZeroBearing: false
                },
                bearing: 0
            }).setView([37.6063, 127.0925], 16);

            // VWorld ê¸°ë³¸ ë°°ê²½ì§€ë„ (Base)
            vworldBaseLayer = L.tileLayer(
                'https://api.vworld.kr/req/wmts/1.0.0/EEB68327-5D04-3BE3-9072-D3ECFCCC26A2/Base/{z}/{y}/{x}.png',
                {
                    attribution: '&copy; VWorld',
                    maxZoom: 19,
                    minZoom: 7
                }
            ).addTo(map);

            // VWorld ë„ë¡œëª…ì£¼ì†Œ ê±´ë¬¼ë²ˆí˜¸ ë ˆì´ì–´ (lt_c_spbd)
            addressLayer = L.tileLayer.wms(
                'https://api.vworld.kr/req/wms',
                {
                    key: 'EEB68327-5D04-3BE3-9072-D3ECFCCC26A2',
                    domain: 'http://localhost',
                    service: 'WMS',
                    request: 'GetMap',
                    layers: 'lt_c_spbd',
                    version: '1.3.0',
                    styles: 'lt_c_spbd',
                    format: 'image/png',
                    transparent: true,
                    crs: L.CRS.EPSG3857,
                    maxZoom: 19,
                    opacity: 1.0,
                    attribution: ''
                }
            ).addTo(map);

            // Google ì§€ë„ ë ˆì´ì–´ ë³€ìˆ˜ ì´ˆê¸°í™” (í•„ìš”í•  ë•Œ ìƒì„±ë¨)
            googleLayer = null;

            // ì§€ë„ í´ë¦­ íŒì—… ë¹„í™œì„±í™” (ì§€ë„ì— ì‹ ì£¼ì†Œ í‘œì‹œë˜ë¯€ë¡œ ë¶ˆí•„ìš”)
            // setupMapClickAddress();

            // ë°°ì†¡ì§€ í‘œì‹œ
            displayMarkers();

            // ë ˆì´ì–´ í† ê¸€ ë²„íŠ¼ ì´ë²¤íŠ¸
            document.getElementById('layerToggleBtn').addEventListener('click', () => {
                const btn = document.getElementById('layerToggleBtn');
                if (currentLayer === 'all') {
                    currentLayer = 'now';
                    btn.textContent = 'ì§€ê¸ˆê°ˆê³³';
                    btn.style.background = '#FF5252';
                    btn.style.color = 'white';
                    btn.style.borderColor = '#D32F2F';
                } else {
                    currentLayer = 'all';
                    btn.textContent = 'ì „ì²´ë³´ê¸°';
                    btn.style.background = 'white';
                    btn.style.color = '#333';
                    btn.style.borderColor = '#CCC';
                }
                displayMarkers();
            });

            // ë ˆë²¨ í•„í„° ì „ì—­ í•¨ìˆ˜ ì„¤ì •
            window.setLevelFilter = (level) => {
                currentLayer = 'level_' + level;
                const btn = document.getElementById('layerToggleBtn');
                btn.textContent = 'ë ˆë²¨' + level;
                btn.style.background = '#673AB7';
                btn.style.color = 'white';
                displayMarkers();

                // í•´ë‹¹ ë ˆë²¨ ë§ˆì»¤ë“¤ë¡œ ì¤Œ
                setTimeout(() => {
                    if (markers.length > 0) {
                        const group = L.featureGroup(markers);
                        map.fitBounds(group.getBounds().pad(0.5), { maxZoom: 19 });
                    }
                }, 100);
            };
        }

        // ê¸°ë³¸ ì§€ë„ ì „í™˜ í•¨ìˆ˜
        function switchToGoogleMap() {
            // API í‚¤ í™•ì¸ (ì¬í™•ì¸)
            if (!window.GOOGLE_MAPS_API_KEY || window.GOOGLE_MAPS_API_KEY.trim() === '') {
                // localStorageì—ì„œ ë‹¤ì‹œ í™•ì¸
                try {
                    const settings = JSON.parse(localStorage.getItem('deliverySettings') || '{}');
                    const apiKey = settings.googleMapsKey || '';
                    window.GOOGLE_MAPS_API_KEY = apiKey;

                    if (!apiKey || apiKey.trim() === '') {
                        const confirmMove = confirm('Google Maps API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\nì„¤ì • í˜ì´ì§€ë¡œ ì´ë™í•˜ì—¬ í‚¤ë¥¼ ì…ë ¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
                        if (confirmMove) {
                            window.location.href = 'settings.html';
                        }
                        return;
                    }
                } catch (e) {
                    console.error('API í‚¤ í™•ì¸ ì‹¤íŒ¨:', e);
                    alert('Google Maps API í‚¤ë¥¼ í™•ì¸í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    return;
                }
            }

            // ë ˆì´ì–´ ìƒì„± (ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•˜ì„ ê²½ìš°)
            if (!googleLayer) {
                if (window.L && window.L.gridLayer && window.L.gridLayer.googleMutant) {
                    try {
                        googleLayer = L.gridLayer.googleMutant({
                            type: 'roadmap' // 'roadmap', 'satellite', 'hybrid', 'terrain'
                        });
                    } catch (e) {
                        console.error('Google Maps ë ˆì´ì–´ ìƒì„± ì‹¤íŒ¨:', e);
                        alert('Google Maps ë ˆì´ì–´ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. API í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
                        return;
                    }
                } else {
                    alert('Google Maps í”ŒëŸ¬ê·¸ì¸ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
            }

            if (currentBaseMap === 'google') return;

            // VWorld ê¸°ë³¸ ë ˆì´ì–´ ì œê±°
            if (vworldBaseLayer && map.hasLayer(vworldBaseLayer)) {
                map.removeLayer(vworldBaseLayer);
            }
            // Google ì§€ë„ ë ˆì´ì–´ ì¶”ê°€
            if (!map.hasLayer(googleLayer)) {
                googleLayer.addTo(map);
            }
            currentBaseMap = 'google';
        }

        function switchToVWorldMap() {
            if (currentBaseMap === 'vworld') return;

            // Google ì§€ë„ ë ˆì´ì–´ ì œê±°
            if (googleLayer && map.hasLayer(googleLayer)) {
                map.removeLayer(googleLayer);
            }
            // VWorld ê¸°ë³¸ ë ˆì´ì–´ ì¶”ê°€
            if (vworldBaseLayer && !map.hasLayer(vworldBaseLayer)) {
                vworldBaseLayer.addTo(map);
            }
            currentBaseMap = 'vworld';
        }

        // ë°°ì†¡ì§€ ë§ˆì»¤ í‘œì‹œ
        async function displayMarkers() {
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            const data = localStorage.getItem('deliveries');
            if (!data) {
                deliveries = [];
                return;
            }

            deliveries = JSON.parse(data);
            const targetId = localStorage.getItem('selectedDeliveryId');

            // ë ˆì´ì–´ í•„í„°ë§
            let filtered = deliveries;
            if (currentLayer === 'now') {
                // 'ì§€ê¸ˆê°ˆê³³': ê¸´ê¸‰ í•­ëª©ì´ê±°ë‚˜ ë ˆì´ì–´ê°€ ì§€ì •ëœ(L1~L5) í•­ëª©
                filtered = deliveries.filter(d => d.urgent || (d.layer && d.layer > 0));
            } else if (currentLayer.startsWith('level_')) {
                const level = parseInt(currentLayer.split('_')[1]);
                filtered = deliveries.filter(d => (d.layer || 0) === level);
            }

            let needSave = false;

            for (let i = 0; i < filtered.length; i++) {
                const delivery = filtered[i];
                const originalIndex = deliveries.findIndex(d => d.id === delivery.id);

                let lat = delivery.lat;
                let lng = delivery.lng;

                // ì¢Œí‘œ ì—†ìœ¼ë©´ ì§€ì˜¤ì½”ë”©
                if (!lat || !lng) {
                    const address = delivery.addressBefore || delivery.addressAfter;
                    if (address) {
                        const coord = await geocodeAddressVWorld(address);
                        if (coord) {
                            lat = coord.lat;
                            lng = coord.lng;
                            deliveries[originalIndex].lat = lat;
                            deliveries[originalIndex].lng = lng;
                            needSave = true;

                            // ë„ë¡œëª…ì£¼ì†Œ ì¡°íšŒ (ì—­ì§€ì˜¤ì½”ë”©)
                            const roadAddr = await getRoadAddressFromCoords(lat, lng);
                            if (roadAddr) {
                                deliveries[originalIndex].roadAddress = roadAddr;
                            }
                        }
                    }
                }

                if (lat && lng) {
                    const markerDiv = document.createElement('div');
                    markerDiv.className = 'custom-marker';
                    if (delivery.urgent) markerDiv.classList.add('urgent');

                    // âœ… ì‹ ì£¼ì†Œ(ë„ë¡œëª…) ê±´ë¬¼ ë²ˆí˜¸ ì¶”ì¶œ
                    // ë°˜ë“œì‹œ ë¡œ/ê¸¸ ì´ í¬í•¨ëœ ë„ë¡œëª… ì£¼ì†Œì—ì„œë§Œ ë²ˆí˜¸ ì¶”ì¶œ (êµ¬ì£¼ì†Œ ë²ˆí˜¸ ë°©ì§€)
                    let buildingNo = "";
                    const roadSrc = delivery.roadAddress ||
                        (/[ë¡œê¸¸]/.test(delivery.addressAfter || '') ? delivery.addressAfter : null) ||
                        (/[ë¡œê¸¸]/.test(delivery.addressBefore || '') ? delivery.addressBefore : null) || '';
                    if (roadSrc) {
                        // ëª¨ë“  [ë¡œê¸¸] ë’¤ ìˆ«ìë¥¼ ì°¾ê³  ë§ˆì§€ë§‰ ê²ƒ ì‚¬ìš© (ì‹ ì£¼ì†Œ ê±´ë¬¼ë²ˆí˜¸)
                        const matches = [...roadSrc.matchAll(/[ë¡œê¸¸]\s*(\d+(?:-\d+)?)/g)];
                        if (matches.length > 0) buildingNo = matches[matches.length - 1][1];
                    }

                    // fallback: ìˆœë²ˆ
                    const label = buildingNo || (originalIndex + 1);

                    markerDiv.innerHTML = `<span>${label}</span>`;

                    const icon = L.divIcon({
                        html: markerDiv.outerHTML,
                        className: '',
                        iconSize: null,
                        iconAnchor: [12, 10]
                    });

                    const marker = L.marker([lat, lng], { icon: icon }).addTo(map);

                    const popupContent = document.createElement('div');
                    const roadAddr = delivery.roadAddress || delivery.addressAfter || '';
                    popupContent.innerHTML = `
                        <div style="margin-bottom:8px;">
                            ${roadAddr ? `<b style="color:#1976D2; font-size:14px;">ğŸ“ ${roadAddr}</b><br>` : ''}
                            <span style="color:#666; font-size:12px;">${delivery.addressBefore || ''}</span>
                        </div>
                        <button onclick="deleteDelivery(${delivery.id})" style="background:#F44336; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; width:100%;">ì‚­ì œ</button>
                    `;
                    marker.bindPopup(popupContent);
                    markers.push(marker);

                    // íŠ¹ì • ì•„ì´ë””ê°€ ì„ íƒë˜ì–´ ë„˜ì–´ì˜¨ ê²½ìš° í•´ë‹¹ ë§ˆì»¤ ê°•ì¡° ë° ì´ë™
                    if (targetId && String(delivery.id) === String(targetId)) {
                        map.setView([lat, lng], 19);
                        marker.openPopup();
                        localStorage.removeItem('selectedDeliveryId'); // í•œ ë²ˆë§Œ ìˆ˜í–‰
                    }
                }
            }

            if (needSave) localStorage.setItem('deliveries', JSON.stringify(deliveries));

            if (markers.length > 0 && !targetId) {
                const group = L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.3), { maxZoom: 18 });
            } else if (markers.length === 0) {
                map.setView([37.6063, 127.0925], 16);
            }

            const totalCount = deliveries.length;
            const filteredCount = filtered.length;
            document.getElementById('headerTitle').textContent = `ì›í„°ì¹˜ ì§€ë„ (${filteredCount}/${totalCount})`;
        }

        // ì§€ë²ˆ ìš°ì„  ì£¼ì†Œ ë³€í™˜ (ì›ë³¸ ì£¼ì†Œ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
        async function geocodeAddressVWorld(address) {
            if (typeof RouteOptimizer === "undefined") return null;
            return await RouteOptimizer.fetchVWorldCoord(address);
        }

        // ë°°ì†¡ì§€ ì‚­ì œ í•¨ìˆ˜
        function deleteDelivery(id) {
            const index = deliveries.findIndex(d => d.id === id);
            if (index !== -1) {
                deliveries.splice(index, 1);
                localStorage.setItem('deliveries', JSON.stringify(deliveries));
                displayMarkers();
            }
        }

        // ë¹¨ê°„ í•€: ë‚´ ìœ„ì¹˜ë¡œ ì¦‰ì‹œ ì´ë™ (ìºì‹œëœ ìœ„ì¹˜ ìš°ì„  ì‚¬ìš©ìœ¼ë¡œ ë”œë ˆì´ ì œê±°)
        function goToMyLocation() {
            if (!navigator.geolocation) {
                alert('GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
                return;
            }

            // ì´ë¯¸ GPS ë§ˆì»¤ê°€ ìˆìœ¼ë©´ ê·¸ ìœ„ì¹˜ë¡œ ì¦‰ì‹œ ì´ë™ (ë”œë ˆì´ ì—†ìŒ)
            if (gpsMarker) {
                const pos = gpsMarker.getLatLng();
                map.setView([pos.lat, pos.lng], 18, { animate: true, duration: 0.3 });
                return;
            }

            // GPS ë§ˆì»¤ ì—†ìœ¼ë©´ maximumAge í—ˆìš©í•´ì„œ ìºì‹œëœ ìœ„ì¹˜ë¼ë„ ë¹ ë¥´ê²Œ ê°€ì ¸ì˜´
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    updatePosition(pos);
                    map.setView([lat, lng], 18, { animate: true, duration: 0.3 });
                },
                (err) => {
                    alert('ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    console.error('GPS Error:', err);
                },
                { enableHighAccuracy: true, maximumAge: 30000, timeout: 5000 }
            );
        }

        // VWorld ì„¤ì •
        let vworldBaseLayer;
        let addressLayer; // ë„ë¡œëª…ì£¼ì†Œ ë ˆì´ì–´
        const VWORLD_KEY = (window.CONFIG && CONFIG.VWORLD_API_KEY) || 'EEB68327-5D04-3BE3-9072-D3ECFCCC26A2';

        // âœ… JSONP ê¸°ë°˜ ì—­ì§€ì˜¤ì½”ë”© (CORS ë¬¸ì œ ì—†ìŒ - Android/Capacitor ëŒ€ì‘)
        function reverseGeocodeJSONP(lng, lat, type) {
            return new Promise((resolve) => {
                const cbName = 'vworldRev_' + Date.now() + '_' + Math.round(Math.random() * 1e5);
                const script = document.createElement('script');
                let done = false;

                const cleanup = () => {
                    delete window[cbName];
                    if (script.parentNode) script.parentNode.removeChild(script);
                };

                const timer = setTimeout(() => {
                    if (!done) { done = true; cleanup(); resolve(null); }
                }, 5000);

                window[cbName] = (data) => {
                    if (done) return;
                    done = true;
                    clearTimeout(timer);
                    cleanup();
                    if (data && data.response && data.response.status === 'OK' && data.response.result) {
                        resolve(data.response.result[0].text || null);
                    } else {
                        resolve(null);
                    }
                };

                script.onerror = () => {
                    if (!done) { done = true; clearTimeout(timer); cleanup(); resolve(null); }
                };

                script.src = `https://api.vworld.kr/req/address?service=address&request=getAddress&version=2.0&crs=epsg:4326&point=${lng},${lat}&format=json&type=${type}&key=${VWORLD_KEY}&callback=${cbName}`;
                document.body.appendChild(script);
            });
        }

        // ì¢Œí‘œë¡œ ë„ë¡œëª…ì£¼ì†Œ ì¡°íšŒ (JSONP ë°©ì‹ìœ¼ë¡œ ë³€ê²½)
        async function getRoadAddressFromCoords(lat, lng) {
            try {
                const text = await reverseGeocodeJSONP(lng, lat, 'ROAD');
                // ê°•ì œ ê²€ì¦: 'ë¡œ'ë‚˜ 'ê¸¸'ì´ ì—†ìœ¼ë©´ ë„ë¡œëª…ì£¼ì†Œê°€ ì•„ë‹˜ â†’ null ë°˜í™˜
                if (text && /[ë¡œê¸¸]/.test(text)) return text;
            } catch (e) {
                console.error('Road address fetch failed', e);
            }
            return null;
        }

        // ì§€ë„ í´ë¦­ ì‹œ ì‹ ì£¼ì†Œ ì¡°íšŒ (ì—­ì§€ì˜¤ì½”ë”©) - âœ… JSONP ë°©ì‹ìœ¼ë¡œ ìˆ˜ì •
        function setupMapClickAddress() {
            map.on('click', async (e) => {
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;

                // ë¡œë”© íŒì—… í‘œì‹œ
                const popup = L.popup()
                    .setLatLng(e.latlng)
                    .setContent('<div style="text-align:center; padding:8px;">ğŸ” ì£¼ì†Œ ì¡°íšŒì¤‘...</div>')
                    .openOn(map);

                // ë„ë¡œëª… + ì§€ë²ˆ ë™ì‹œ ì¡°íšŒ (JSONP)
                const [roadAddr, jibunAddr] = await Promise.all([
                    reverseGeocodeJSONP(lng, lat, 'ROAD'),
                    reverseGeocodeJSONP(lng, lat, 'PARCEL')
                ]);

                let html = '<div style="font-size:13px; line-height:1.8; max-width:260px; padding:2px 0;">';

                if (roadAddr) {
                    html += `<div style="font-weight:bold; color:#1976D2; margin-bottom:2px;">ğŸ“ ${roadAddr}</div>`;
                }
                if (jibunAddr) {
                    html += `<div style="color:#666; font-size:11px;">ì§€ë²ˆ: ${jibunAddr}</div>`;
                }
                if (!roadAddr && !jibunAddr) {
                    // âœ… ì£¼ì†Œ ì—†ëŠ” ì§€ì—­ í´ë¦­ ì‹œ íŒì—… ì•ˆ ëœ¨ê²Œ (ìš”ì²­ì‚¬í•­)
                    map.closePopup();
                    return;
                }

                // ë³µì‚¬ ë²„íŠ¼ (ë„ë¡œëª… ìš°ì„ , ì—†ìœ¼ë©´ ì§€ë²ˆ)
                const copyTarget = roadAddr || jibunAddr;
                if (copyTarget) {
                    const escaped = copyTarget.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
                    html += `<button onclick="
                        if(navigator.clipboard){
                            navigator.clipboard.writeText('${escaped}')
                                .then(()=>{this.textContent='âœ… ë³µì‚¬ë¨!'; setTimeout(()=>this.textContent='ğŸ“‹ ì£¼ì†Œ ë³µì‚¬',1500);})
                                .catch(()=>{this.textContent='âŒ ì‹¤íŒ¨';});
                        } else {
                            const el=document.createElement('textarea');
                            el.value='${escaped}';
                            document.body.appendChild(el);
                            el.select();
                            document.execCommand('copy');
                            document.body.removeChild(el);
                            this.textContent='âœ… ë³µì‚¬ë¨!';
                            setTimeout(()=>this.textContent='ğŸ“‹ ì£¼ì†Œ ë³µì‚¬',1500);
                        }
                    " style="margin-top:8px; background:#4CAF50; color:white; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; font-size:12px; width:100%; font-weight:600;">ğŸ“‹ ì£¼ì†Œ ë³µì‚¬</button>`;
                }
                html += '</div>';

                popup.setContent(html);
            });
        }

        // ========================================
        // ğŸ“ ì´ˆê³ ì† ë°˜ì‘ GPS íŠ¸ë˜í‚¹
        // ========================================
        let gpsMarker = null;
        let watchId = null;
        let isTracking = false;
        let isUserInteracting = false;

        // ì§€ë„ ì¡°ì‘ ê°ì§€
        function setupInteractionListeners() {
            if (!map) return;
            const pause = () => { isUserInteracting = true; };
            const resume = () => { setTimeout(() => isUserInteracting = false, 2000); };
            map.on('movestart', pause); map.on('zoomstart', pause); map.on('dragstart', pause);
            map.on('moveend', resume); map.on('zoomend', resume); map.on('dragend', resume);
        }

        document.getElementById('locationBtn').addEventListener('click', toggleTracking);

        function toggleTracking() {
            const btn = document.getElementById('locationBtn');

            // 1. ì´ë¯¸ íŒŒë€ ì (GPS ë§ˆì»¤)ì´ ìˆë‹¤ë©´? -> 0ì´ˆ ëŒ€ê¸°, ì¦‰ì‹œ ì´ë™!
            if (gpsMarker) {
                const center = map.getCenter();
                const markerLL = gpsMarker.getLatLng();
                const dist = map.distance(center, markerLL);

                // ì¤‘ì‹¬ì—ì„œ 5m ì´ìƒ ë²—ì–´ë‚˜ ìˆìœ¼ë©´ -> "ì¦‰ì‹œ ì´ë™" (íŠ¸ë˜í‚¹ ì•ˆ ë”)
                if (dist > 5) {
                    const bearing = (map.getBearing && typeof map.getBearing === 'function') ? map.getBearing() : 0;
                    map.setView(markerLL, 17, {
                        animate: true,
                        duration: 0.3,
                        easeLinearity: 0.25,
                        bearing: bearing
                    });

                    // ë§Œì•½ êº¼ì ¸ìˆë˜ ìƒíƒœë¼ë©´ ì¼œê¸°
                    if (!isTracking) {
                        isTracking = true;
                        btn.classList.add('active');
                        startWatch();
                    }
                    return;
                }
            }

            // 2. íŠ¸ë˜í‚¹ ìƒíƒœ í† ê¸€ (ì¤‘ì‹¬ì— ìˆì„ ë•Œë§Œ êº¼ì§)
            if (isTracking) {
                stopWatch();
                btn.classList.remove('active');
            } else {
                startWatch();
                btn.classList.add('active');
            }
        }

        function startWatch() {
            if (!navigator.geolocation) { alert('GPS ë¶ˆê°€'); return; }
            isTracking = true;
            setupInteractionListeners();

            // ì´ˆê¸° ìœ„ì¹˜ ì¡ê¸°
            if (!gpsMarker) {
                navigator.geolocation.getCurrentPosition(updatePosition, null, { enableHighAccuracy: true, maximumAge: 0 });
            }

            if (watchId === null) {
                watchId = navigator.geolocation.watchPosition(updatePosition, console.error, {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 5000
                });
            }
        }

        function stopWatch() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            isTracking = false;
        }

        function updatePosition(pos) {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;

            if (!map.getPane('gpsPane')) {
                map.createPane('gpsPane');
                map.getPane('gpsPane').style.zIndex = 2000;
                map.getPane('gpsPane').style.pointerEvents = 'none';
            }

            if (!gpsMarker) {
                const icon = L.divIcon({ className: 'gps-pulse-icon', html: '<div class="gps-dot"></div><div class="gps-pulse"></div>', iconSize: [20, 20] });
                gpsMarker = L.marker([lat, lng], { icon: icon, pane: 'gpsPane' }).addTo(map);
            } else {
                gpsMarker.setLatLng([lat, lng]);
            }

            if (isTracking && !isUserInteracting) {
                const bearing = (map.getBearing && typeof map.getBearing === 'function') ? map.getBearing() : 0;
                map.setView([lat, lng], 17, { bearing: bearing, animate: true, duration: 0.2 });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            // âœ… layerFilter ìš”ì†ŒëŠ” HTMLì— ì—†ìœ¼ë¯€ë¡œ í•´ë‹¹ ì°¸ì¡° ì œê±° (ì˜¤ë¥˜ ìˆ˜ì •)
            // layerToggleBtn í´ë¦­ ì´ë²¤íŠ¸ëŠ” initMap() ì•ˆì—ì„œ ì´ë¯¸ ë“±ë¡ë¨ (ì¤‘ë³µ ì œê±°)

            // ë‚´ ìœ„ì¹˜ë¡œ ì¦‰ì‹œ ì´ë™ ë²„íŠ¼ (ë¹¨ê°„ í•€)
            const myLocBtn = document.createElement('button');
            myLocBtn.id = 'myLocationBtn';
            myLocBtn.className = 'location-btn';
            myLocBtn.style.bottom = '140px';
            myLocBtn.style.fontSize = '20px';
            myLocBtn.style.background = '#FF5252';
            myLocBtn.style.color = 'white';
            myLocBtn.style.border = '2px solid #D32F2F';
            myLocBtn.innerHTML = 'ğŸ“Œ';
            myLocBtn.onclick = goToMyLocation;
            document.body.appendChild(myLocBtn);
        });
    </script>
    <!-- Google Maps API (ì„¤ì • í˜ì´ì§€ì—ì„œ ì €ì¥í•œ í‚¤ë¥¼ ì‚¬ìš©) -->
    <script>
        // ì„¤ì • í˜ì´ì§€ì—ì„œ ì €ì¥ëœ Google Maps API í‚¤ ë¶ˆëŸ¬ì˜¤ê¸°
        const loadGoogleMapsAPI = () => {
            try {
                const settings = JSON.parse(localStorage.getItem('deliverySettings') || '{}');
                const apiKey = settings.googleMapsKey || '';
                window.GOOGLE_MAPS_API_KEY = apiKey;

                if (apiKey && apiKey.trim() !== '') {
                    const script = document.createElement('script');
                    script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}`;
                    script.async = true;
                    script.defer = true;
                    document.head.appendChild(script);
                    console.log('Google Maps API í‚¤ ë¡œë“œë¨');
                } else {
                    console.log('Google Maps API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì„¤ì • í˜ì´ì§€ì—ì„œ ì…ë ¥í•˜ì„¸ìš”.');
                }
            } catch (error) {
                console.error('Google Maps API í‚¤ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        };

        // í˜ì´ì§€ ë¡œë“œ ì‹œ API í‚¤ ë¡œë“œ
        loadGoogleMapsAPI();
    </script>
</body>

</html>